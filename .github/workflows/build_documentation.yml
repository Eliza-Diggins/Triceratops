# .github/workflows/docs.yml
# ------------------------------------------------------------- #
# GitHub Actions Workflow to Build and Deploy Pisces Docs      #
# ------------------------------------------------------------- #
# This workflow builds and deploys the documentation for the
# Pisces project using Sphinx. It supports two deployment modes:
#
# 1. Dev docs:   pushed to `/dev` when a `dev_*` branch is updated
# 2. Stable docs: pushed to `/stable` when a `vX.Y.Z` tag is pushed
#
# A redirect index is also deployed to root `/` on main or version tag.
name: Build and Deploy Documentation

# This workflow builds and deploys the documentation for the Pisces project.
# It supports two deployment modes:
# 1. Dev docs:   pushed to `/dev` when a `dev_*` branch is updated
# 2. Stable docs: pushed to `/stable` when a `vX.Y.Z` tag is pushed
# A redirect index is also deployed to root `/` on main or version tag.
on:
  push:
    branches:
      - main
      - dev-*              # Match dev branches like dev_v1.4.0
    tags:
      - "v*"               # Match version tags like v1.2.0
  workflow_dispatch:

# Perform the workflow.
jobs:
  docs:
    name: Build and Deploy Documentation
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup the python environment for the operation.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # Cache pip dependencies to speed up builds. This
      # depends on the os and the hash of the pyproject.toml file.
      # It will therefore be invalidated when the dependencies change.
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-docs-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-docs-

      # Install the dependencies required to build the documentation.
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[docs]

      # Actually build the documentation. We use the `-j auto` flag to
      # allow Sphinx to use all available CPU cores for faster builds.
      - name: Build documentation with Sphinx
        run: |
          mkdir -p docs/_build/html
          sphinx-build -b html -j auto docs/source docs/_build/html

      # Deploy redirect index.html to root (only on main or stable tag)
      - name: Deploy redirect index.html to root
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: docs/redirect
          destination_dir: .

      # Deploy the built HTML to /stable or /dev
      - name: Deploy versioned documentation
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: docs/_build/html
          destination_dir: ${{ startsWith(github.ref, 'refs/tags/v') && 'stable' || 'dev' }}
